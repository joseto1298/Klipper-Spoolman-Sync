###################################################
# CONFIGURACIÓN DE SHELL COMMANDS PARA SCRIPTS PYTHON
#
# Nota: Asegúrate de que las rutas a 'venv/bin/python3' y a los scripts 
#       sean correctas en tu instalación.
###################################################

[gcode_shell_command FILAMENT_LIST]
# Ejecuta el script filamentList.py para analizar el G-code en busca de IDs de filamento.
command: /home/pi/Klipper-Spoolman-Sync/venv/bin/python3 /home/pi/Klipper-Spoolman-Sync/filamentList.py
timeout: 10
verbose: True

[gcode_shell_command FILAMENT_NOTICE]
# Ejecuta el script filamentNotice.py para consultar un ID de filamento y enviar la info a Klipper.
command: /home/pi/Klipper-Spoolman-Sync/venv/bin/python3 /home/pi/Klipper-Spoolman-Sync/filamentNotice.py
timeout: 10
verbose: True

###################################################
# MACROS DE GCODE PARA GESTIÓN DE FILAMENTOS
###################################################

[gcode_macro _FILAMENT_LIST]
description: "Ejecuta el script de detección de filamentos al iniciar una impresión"
gcode:
    {% if printer.print_stats.filename %}
        {% set file = printer.print_stats.filename %}
        RESPOND PREFIX="Filamento" MSG="Iniciando análisis de filamentos para el archivo: {file}"
        # Llama al shell command, pasando el nombre del archivo como parámetro
        RUN_SHELL_COMMAND CMD=FILAMENT_LIST PARAMS="{file}"
    {% else %}
        RESPOND PREFIX="Filamento" MSG="?? No hay archivo de impresión activo. No se puede analizar."
    {% endif %}


[gcode_macro FILAMENT_INFO]
description: Muestra información del filamento y pausa para cambio manual
gcode:
    # Parámetros recibidos del script filamentNotice.py a través de Moonraker
    {% set id = params.ID|int %}
    {% set name = params.NAME|default("Desconocido") %}
    {% set material = params.MATERIAL|default("Desconocido") %}
    
    # 1. Mensajes de consola y pantalla
    M117 Cambia a {id} { material } { name } 
    RESPOND TYPE=command MSG="Cambia el filamento a {id} { material } { name }"
    
    # 2. Comando de notificación/alarma externa (por ejemplo, para Telegram)
    RESPOND PREFIX=tgalarm_photo MSG="Cambia Filamento a {id} { material } { name }"
    
    # 3. Recomendación: Pausar la impresión
    # PAUSE 
    # M118 PAUSA para cambiar filamento {id}